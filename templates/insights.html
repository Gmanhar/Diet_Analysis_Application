<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nutritional Insights</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='insights.css') }}" />
</head>
<body>
  <header>
    <h1>Nutritional Insights</h1>
    {% if user_name %}
      <div class="user-info">
        <span>Welcome, {{ user_name }}</span>
        <a href="{{ url_for('logout') }}">Logout</a>
      </div>
    {% endif %}
  </header>

  <main>
    <!-- API form -->
    <section class="api" aria-labelledby="api-heading">
      <h2 id="api-heading">Explore Nutritional Insights</h2>

      <form method="POST" id="insights-form">
        <div class="filters-inline">
          <label for="dietType">Search by Diet Type</label>
          <select id="dietType" name="dietType">
            <option value="" {% if not selected_diet %}selected{% endif %}>
              All Diet Types
            </option>
            {% for d in diet_options %}
              <option value="{{ d }}" {% if selected_diet == d %}selected{% endif %}>
                {{ d }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="filters-inline">
          <label for="keyword">Search by Keyword</label>
          <input
            type="text"
            id="keyword"
            name="keyword"
            placeholder="e.g. chicken, salad, american"
            value="{{ keyword or '' }}"
          />
        </div>

        <div class="button-row">
          <button class="blue" type="submit" name="action" value="insights">
            Get Nutritional Insights
          </button>
          <button class="green" type="submit" name="action" value="recipes">
            Get Recipes
          </button>
          <button class="purple" type="submit" name="action" value="clusters">
            Get Clusters
          </button>
        </div>

        <!-- current page for pagination -->
        <input type="hidden" name="page" id="page-field" value="{{ current_page }}" />
      </form>
    </section>

    {% if message %}
<section class="pagination" aria-label="Pagination">
  <p>Pagination</p>

  <div class="pager" id="pager" data-max-page="{{ total_pages }}">
    <!-- Previous -->
    <button type="button" class="pager-btn" data-page="prev">Previous</button>

    <!-- Always show page 1 -->
    <button type="button"
      class="pager-btn {% if current_page == 1 %}active{% endif %}"
      data-page="1">1</button>

    {% if current_page > 4 %}
      <span class="pager-ellipsis">…</span>
    {% endif %}

    {% for p in range(current_page - 2, current_page + 3) %}
      {% if p > 1 and p < total_pages %}
        <button type="button"
          class="pager-btn {% if p == current_page %}active{% endif %}"
          data-page="{{ p }}">{{ p }}</button>
      {% endif %}
    {% endfor %}

    {% if current_page < total_pages - 3 %}
      <span class="pager-ellipsis">…</span>
    {% endif %}

    {% if total_pages > 1 %}
      <button type="button"
        class="pager-btn {% if current_page == total_pages %}active{% endif %}"
        data-page="{{ total_pages }}">{{ total_pages }}</button>
    {% endif %}

    <!-- Next -->
    <button type="button" class="pager-btn" data-page="next">Next</button>
  </div>
</section>
{% endif %}


    <!-- Charts with descriptions above -->
    {% if charts %}
      <section class="results" aria-labelledby="charts-heading">
        <div class="chart-grid">
          {% if charts.bar %}
            <div class="chart-item">
              <div class="chart-description">
                <h3>Bar Chart</h3>
                <p>Average macronutrient content by diet type.</p>
              </div>
              <img src="data:image/png;base64,{{ charts.bar }}" alt="Bar chart" />
            </div>
          {% endif %}
          
          {% if charts.scatter %}
            <div class="chart-item">
              <div class="chart-description">
                <h3>Scatter Plot</h3>
                <p>Nutrient relationships (e.g., protein vs carbs).</p>
              </div>
              <img src="data:image/png;base64,{{ charts.scatter }}" alt="Scatter chart" />
            </div>
          {% endif %}
          
          {% if charts.heatmap %}
            <div class="chart-item">
              <div class="chart-description">
                <h3>Heatmap</h3>
                <p>Nutrient correlations.</p>
              </div>
              <img src="data:image/png;base64,{{ charts.heatmap }}" alt="Heatmap" />
            </div>
          {% endif %}
          
          {% if charts.pie %}
            <div class="chart-item">
              <div class="chart-description">
                <h3>Pie Chart</h3>
                <p>Recipe distribution by diet type.</p>
              </div>
              <img src="data:image/png;base64,{{ charts.pie }}" alt="Pie chart" />
            </div>
          {% endif %}
        </div>
      </section>
    {% endif %}

    <!-- Recipes and Clusters (text list from `message`) -->
    {% if message %}
      <section class="results">
        <h2>{% if request.form.get('action') == 'clusters' %}Cluster Analysis{% else %}Recipes{% endif %}</h2>
        <ul class="recipe-list">
          {% for m in message %}
            <li>{{ m }}</li>
          {% endfor %}
        </ul>
      </section>
    {% endif %}
  </main>

  <script>
    const pager = document.getElementById("pager");
    const maxPage = parseInt(pager.dataset.maxPage, 10);
    const form = document.getElementById("insights-form");
    const pageField = document.getElementById("page-field");

    document.querySelectorAll(".pager-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        let current = parseInt(pageField.value, 10) || 1;
        let target = btn.dataset.page;

        if (target === "prev") {
          target = current - 1;
        } else if (target === "next") {
          target = current + 1;
        } else {
          target = parseInt(target, 10);
        }

        if (target < 1) target = 1;
        if (target > maxPage) target = maxPage;

        pageField.value = target;

        // keep action=recipes on paging
        const hiddenAction = document.createElement("input");
        hiddenAction.type = "hidden";
        hiddenAction.name = "action";
        hiddenAction.value = "recipes";
        form.appendChild(hiddenAction);

        form.submit();
      });
    });
  </script>
</body>
</html>